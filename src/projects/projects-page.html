<link rel="import" href="../bower_components/carbon-route/carbon-route.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">

<link rel="import" href="../pull-request/pull-request-page.html">
<link rel="import" href="project-pull-requests.html">
<link rel="import" href="no-project-selected.html">
<link rel="import" href="project-overview-page.html">
<link rel="import" href="project-list-item.html">
<link rel="import" href="../ajax/authenticated-ajax.html">
<link rel="import" href="../list-items/preview-list.html">
<link rel="import" href="search-behavior.html">
<link rel="import" href="search-box.html">
<link rel="import" href="../list-items/list-tab.html">

<dom-module id="projects-page">
  <template>
    <style>
      :host {
        flex: 1;
        display: flex;
        -webkit-transition: all 500ms ease;
        -moz-transition: all 500ms ease;
        -ms-transition: all 500ms ease;
        -o-transition: all 500ms ease;
        transition: all 500ms ease;
      }
      [hidden] {
        display: none !important;
      }
      aside {
        position: fixed;
        z-index: 2;
        height: 100%;
      }
      aside .container {
        position: relative;
        max-width: 400px;
        height: 100%;
        display: flex;
        transform: translateX(-102%);
        will-change: transform;
        transition: transform 0.5s ease;
      }
      aside.no-list {
        position: relative;
        flex: 1;
        max-width: 0;
      }
      aside:not(.no-list) .container {
        transform: none;
      }
      iron-pages {
        overflow: auto;
        width: 100%;
        flex: 1;
        will-change: width;
        transition: width 0.5s ease;
      }
      .filler {
        width: 0;
        max-width: 400px;
        will-change: width;
        transition: width 0.5s ease;
        background-color: var(--secondary-background-color);
      }
      aside:not(.no-list) + .filler {
        width: 400px;
      }
      aside:not(.no-list) + iron-pages {
        width: calc(100vw - 400px);
      }
      .project-list,
      .pull-list {
        transition: width 0.5s ease;
        min-width: 400px;
        width: 400px;
        flex: 1;
        min-height: 100%;
        background-color: var(--primary-background-color);
        -webkit-box-shadow: 0 0 8px 0 rgba(0,0,0,0.2);
        box-shadow: 0 0 8px 0 rgba(0,0,0,0.2);
      }
      .project-list.false,
      .pull-list.false {
        width: 0;
      }
      .project {
        display: flex;
      }
      project-overview-page {
        flex: 1;
      }
      a {
        color: inherit;
      }
      search-box {
        margin-top: 19.920px;
      }
      .tabs {
        z-index: 4;
        flex-direction: column;
        min-width: var(--sidebar-width);
        max-width: var(--sidebar-width);
        height: calc(100vh - 48px);
        overflow: hidden;
      }
      .rotate {
        flex: 1;
        margin-top: -var(--sidebar-width);
        background-color: var(--sidebar-background-color);
        width: 100vh;
        transform: rotate(0.25turn);
        transform-origin: bottom left;
        -webkit-box-shadow: inset 0 3px 8px 2px rgba(0,0,0,0.5);
        box-shadow: inset 0 3px 8px 2px rgba(0,0,0,0.5);
      }
    </style>
    <carbon-route route="{{route}}" pattern="/:owner/:name" data="{{projectTitle}}" tail="{{nameTail}}" active="{{projectSelected}}"></carbon-route>
    <carbon-route route="{{nameTail}}" pattern="/pulls/:pr" data="{{pr}}" tail="{{prTail}}" active="{{pullRequestSelected}}"></carbon-route>

    <authenticated-ajax
      id="ajaxPullRequest"
      refurl="https://api.github.com/repos/[[projectTitle.owner]]/[[projectTitle.name]]/pulls"
      handle-as="json"
      last-response="{{pullrequests}}"></authenticated-ajax>

    <div class="tabs">
      <div class="rotate">
        <list-tab selected="{{showProjectsList}}" icon="icons:view-list">Repositories</list-tab>
        <list-tab selected="{{showPullList}}" hidden$="[[!projectSelected]]" icon="editor:merge-type">Pull Requests</list-tab>
      </div>
    </div>
    <aside class$="collapsable [[_calcListClass(showProjectsList, showPullList)]]">
      <div class="container">
        <div class="project-list" hidden$="[[!showProjectsList]]">
          <preview-list>
            <search-box value="{{searchWord}}"></search-box>
            <template is="dom-repeat" items="[[search(projects, searchWord)]]" as="project">
              <a href$="[[route.prefix]]/[[project.owner]]/[[project.name]]/activity" tabindex="-1">
                <project-list-item project="[[project]]" selected="[[_isActiveProject(project, activeProject)]]"
                                   tabindex="0" on-keydown="maybeOpenProject"></project-list-item>
              </a>
            </template>
          </preview-list>
        </div>

        <project-pull-requests class="pull-list" hidden$="[[!showPullList]]" route="{{nameTail}}" tabindex="0"
                             project="[[projectTitle.owner]]" pullrequests="[[pullrequests]]"
                             prid-selected="[[prid]]"></project-pull-requests>
      </div>
    </aside>
    <div class="filler"></div>

    <iron-pages class="project"
                selected="[[_getCurrentView(projectSelected, pullRequestSelected)]]"
                attr-for-selected="data-route">
        <no-project-selected data-route="no-selected"></no-project-selected>
        <project-overview-page data-route="overview" tabindex="0" on-tap="_hideProjectList"
            project="[[activeProject]]" route="{{nameTail}}" pullrequests="[[pullrequests]]"></project-overview-page>
        <pull-request-page data-route="pr" prid="[[prid]]" route="{{prTail}}" pullrequests="[[pullrequests]]"
                           project="[[projectTitle]]"></pull-request-page>
    </iron-pages>
  </template>
  <script>
    Polymer({
      is: 'projects-page',
      behaviors: [searchBehavior],
      properties: {
        searchWord: {
          type: String,
          value: ''
        },
        showProjectsList: {
          type: Boolean,
          value: false
        },
        showPullList: Boolean,
        route: {
          type: Object,
          notify: true
        },
        prid: {
          type: Number,
          computed: '_parseInt(pr.pr)'
        },
        projects: {
          type: Array,
          value: function() {
            return [
              {
                owner: 'Polymer',
                name: 'Polymer',
                activity: '3 hours ago',
                issues: 500,
                prs: 20,
                notification: true
              },
              {
                owner: 'preview-code',
                name: 'rite-evaluation',
                activity: '3 hours ago',
                issues: 3,
                prs: 2,
                notification: true
              },
              {
                owner: 'preview-code',
                name: 'frontend',
                activity: '5 days ago',
                issues: 15,
                prs: 3,
                notification: false
              },
              {
                owner: 'preview-code',
                name: 'backend',
                activity: '7 days ago',
                issues: 20,
                prs: 5,
                notification: true
              }
            ];
          }
        },
        getFields: {
          type: Function,
          value: function() {
            return function(projectData) {
              return [projectData.name, projectData.owner];
            };
          }
        },
        activeProject: Object
      },
      observers: [
        'chooseProject(projectTitle.*)',
        '_resetListsOnProjectChange(projectSelected)',
        '_resetListsOnPullChange(pullRequestSelected)'
      ],
      chooseProject: function(projectTitle) {
        var owner = projectTitle.value.owner;
        var name = projectTitle.value.name;
        if (!owner || !name) {
          return;
        }

        this.activeProject = this.projects.filter(function(p) {
          return p.owner === owner && p.name === name;
        })[0];

        this.$.ajaxPullRequest.generateRequest();
      },
      maybeOpenProject: function(e) {
        if (e.keyCode === 13) {
          this.set('route.path', e.model.project.owner + '/' + e.model.project.name + '/activity');
          this.$$('project-overview-page').focus();
        }
      },
      _parseInt: function(num) {
        return parseInt(num);
      },
      _calcListClass: function(showProjectsList, showPullList) {
        if (!showProjectsList && !showPullList) {
          return 'no-list';
        } else if (showProjectsList && showPullList) {
          return 'both-list';
        }
        return 'one-list';
      },
      _isActiveProject: function(project, activeProject) {
        return project === activeProject;
      },
      _getCurrentView: function(projectSelected, pullRequestSelected) {
        if (!projectSelected) {
          return 'no-selected';
        } else if (!pullRequestSelected) {
          return 'overview';
        }
        return 'pr';
      },
      _resetListsOnProjectChange: function(newValue) {
        this.showProjectsList = true;
        this.showPullList = newValue;
      },
      _resetListsOnPullChange: function(newValue) {
        this.showProjectsList = this.showProjectsList && !newValue;
      },
      _hideProjectList: function() {
        this.showProjectsList = false;
      }
    });
  </script>
</dom-module>
