<link rel="import" href="../../bower_components/carbon-route/carbon-route.html">
<link rel="import" href="../../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../pull-request/pull-request-page.html">
<link rel="import" href="project-pull-requests.html">
<link rel="import" href="no-project-selected.html">
<link rel="import" href="project-overview-page.html">
<link rel="import" href="project-list-item.html">
<link rel="import" href="../ajax/authenticated-ajax.html">
<link rel="import" href="../list-items/preview-list.html">

<dom-module id="projects-page">
  <template>
    <style>
      :host {
        display: flex;
        flex: 1;
      }
      [hidden] {
        display: none !important;
      }
      .container {
        display: flex;
        flex: 1;
        flex-direction: row;
      }
      preview-list, .project {
        flex: 1;
      }
      preview-list {
        max-width: 325px;
        border-right: solid 4px var(--secondary-background-color);
      }
      .project {
        display: flex;
      }
      project-overview-page {
        flex: 1;
      }
      project-pull-requests {
        max-width: 600px;
      }
      project-overview-page,
      project-pull-requests,
      preview-list {
        overflow-y: auto;
        overflow-x: hidden;
      }
      a {
        color: inherit;
      }
    </style>
    <carbon-route route="{{route}}" pattern="/:owner/:name" data="{{projectTitle}}" tail="{{nameTail}}"></carbon-route>
    <carbon-route route="{{nameTail}}" pattern="/pulls/:pr" data="{{pr}}" tail="{{tail}}"></carbon-route>

    <authenticated-ajax
      id="ajaxPullRequest"
      refurl="https://api.github.com/repos/[[projectTitle.owner]]/[[projectTitle.name]]/pulls"
      handle-as="json"
      last-response="{{pullrequests}}"></authenticated-ajax>

    <div class="container">
      <preview-list hidden$="[[_shouldShowProjects(name, pr)]]">
        <template is="dom-repeat" items="[[projects]]" as="project">
          <a href$="[[route.prefix]]/[[project.owner]]/[[project.name]]/pulls" tabindex="-1">
            <project-list-item project="[[project]]" selected="[[_isActiveProject(project, activeProject)]]"
                               tabindex="0" on-keydown="maybeOpenProject"></project-list-item>
          </a>
        </template>
      </preview-list>
      <project-pull-requests hidden$="[[!_shouldShowProjects(name, pr)]]" route="{{nameTail}}" tabindex="0"
                             owner="[[projectTitle.owner]]" name="[[projectTitle.name]]" pullrequests="[[pullrequests]]"></project-pull-requests>

      <iron-pages class="project"
                  selected="[[_getCurrentView(projectTitle, pr)]]"
                  attr-for-selected="data-route">
          <no-project-selected data-route="no-selected"></no-project-selected>
          <project-overview-page data-route="overview" tabindex="0"
              project="[[activeProject]]" route="{{nameTail}}" pullrequests="[[pullrequests]]"></project-overview-page>
          <pull-request-page data-route="pr" prid="[[pr.pr]]"
                             owner="[[projectTitle.owner]]" name="[[projectTitle.name]]"></pull-request-page>
      </iron-pages>
    </div>
  </template>
  <script>
    Polymer({
      is: 'projects-page',
      properties: {
        route: {
          type: Object,
          notify: true
        },
        projects: {
          type: Array,
          value: function() {
            return [
              {
                owner: 'Polymer',
                name: 'Polymer',
                activity: '3 hours ago',
                issues: 500,
                prs: 20,
                notification: true
              },
              {
                owner: 'preview-code',
                name: 'frontend',
                activity: '5 days ago',
                issues: 15,
                prs: 3,
                notification: false
              },
              {
                owner: 'preview-code',
                name: 'backend',
                activity: '7 days ago',
                issues: 20,
                prs: 5,
                notification: true
              },
              {
                owner: 'preview-code',
                name: 'frontend',
                activity: '5 days ago',
                issues: 15,
                prs: 3,
                notification: false
              },
              {
                owner: 'preview-code',
                name: 'frontend',
                activity: '5 days ago',
                issues: 15,
                prs: 3,
                notification: false
              },
              {
                owner: 'preview-code',
                name: 'frontend',
                activity: '5 days ago',
                issues: 15,
                prs: 3,
                notification: false
              },
              {
                owner: 'preview-code',
                name: 'frontend',
                activity: '5 days ago',
                issues: 15,
                prs: 3,
                notification: false
              },
              {
                owner: 'preview-code',
                name: 'frontend',
                activity: '5 days ago',
                issues: 15,
                prs: 3,
                notification: false
              },
              {
                owner: 'preview-code',
                name: 'frontend',
                activity: '5 days ago',
                issues: 15,
                prs: 3,
                notification: false
              },
              {
                owner: 'preview-code',
                name: 'frontend',
                activity: '5 days ago',
                issues: 15,
                prs: 3,
                notification: false
              },
              {
                owner: 'preview-code',
                name: 'frontend',
                activity: '5 days ago',
                issues: 15,
                prs: 3,
                notification: false
              },
              {
                owner: 'preview-code',
                name: 'frontend',
                activity: '5 days ago',
                issues: 15,
                prs: 3,
                notification: false
              },
              {
                owner: 'preview-code',
                name: 'frontend',
                activity: '5 days ago',
                issues: 15,
                prs: 3,
                notification: false
              },
              {
                owner: 'preview-code',
                name: 'frontend',
                activity: '5 days ago',
                issues: 15,
                prs: 3,
                notification: false
              },
              {
                owner: 'preview-code',
                name: 'frontend',
                activity: '5 days ago',
                issues: 15,
                prs: 3,
                notification: false
              },
              {
                owner: 'preview-code',
                name: 'frontend',
                activity: '5 days ago',
                issues: 15,
                prs: 3,
                notification: false
              },
              {
                owner: 'preview-code',
                name: 'frontend',
                activity: '5 days ago',
                issues: 15,
                prs: 3,
                notification: false
              },
              {
                owner: 'preview-code',
                name: 'frontend',
                activity: '5 days ago',
                issues: 15,
                prs: 3,
                notification: false
              },
              {
                owner: 'preview-code',
                name: 'frontend',
                activity: '5 days ago',
                issues: 15,
                prs: 3,
                notification: false
              },
              {
                owner: 'preview-code',
                name: 'frontend',
                activity: '5 days ago',
                issues: 15,
                prs: 3,
                notification: false
              },
              {
                owner: 'preview-code',
                name: 'frontend',
                activity: '5 days ago',
                issues: 15,
                prs: 3,
                notification: false
              },
              {
                owner: 'preview-code',
                name: 'frontend',
                activity: '5 days ago',
                issues: 15,
                prs: 3,
                notification: false
              },
              {
                owner: 'preview-code',
                name: 'frontend',
                activity: '5 days ago',
                issues: 15,
                prs: 3,
                notification: false
              },
              {
                owner: 'preview-code',
                name: 'frontend',
                activity: '5 days ago',
                issues: 15,
                prs: 3,
                notification: false
              },
              {
                owner: 'preview-code',
                name: 'frontend',
                activity: '5 days ago',
                issues: 15,
                prs: 3,
                notification: false
              },
              {
                owner: 'preview-code',
                name: 'frontend',
                activity: '5 days ago',
                issues: 15,
                prs: 3,
                notification: false
              },
              {
                owner: 'preview-code',
                name: 'frontend',
                activity: '5 days ago',
                issues: 15,
                prs: 3,
                notification: false
              },
              {
                owner: 'preview-code',
                name: 'frontend',
                activity: '5 days ago',
                issues: 15,
                prs: 3,
                notification: false
              }
            ];
          }
        }
      },
      observers: [
        'chooseProject(projectTitle.*)'
      ],

      chooseProject: function(projectTitle) {
        var owner = projectTitle.value.owner;
        var name = projectTitle.value.name;
        if (!owner || !name) {
          return;
        }

        this.activeProject = this.projects.filter(function(p) {
          return p.owner === owner && p.name === name;
        })[0];

        this.$.ajaxPullRequest.generateRequest();
      },
      _resolvePath: function(owner, name) {
        return this.resolveUrl(owner + '/' + name + '/pulls');
      },
      maybeOpenProject: function(e) {
        if (e.keyCode === 13) {
          this.set('owner.owner', e.model.project.owner);
          this.set('name.name', e.model.project.name);
          this.set('nameTail.path', 'pulls');
          this.$$('project-overview-page').focus();
        }
      },
      _has: function() {
        return Array.prototype.slice.call(arguments).reduce(function(prev, current) {
          return prev && !!current;
        }, true);
      },
      _isActiveProject: function(name, project, activeProject) {
        return !!name && project === activeProject;
      },
      _getCurrentView: function(name, pr) {
        if (!name.name) {
          return 'no-selected';
        } else if (!pr.pr) {
          return 'overview';
        }
        return 'pr';
      },
      _shouldShowProjects: function(name, pr) {
        return this._getCurrentView(name, pr) === 'pr';
      }
    });
  </script>
</dom-module>
