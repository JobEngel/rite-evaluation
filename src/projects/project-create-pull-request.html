<link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../bower_components/prism-element/prism-highlighter.html">
<link rel="import" href="../bower_components/prism-element/prism-style-import.html">
<link rel="import" href="../util/marked-github-element.html">
<link rel="import" href="../util/branch-tag.html">
<link rel="import" href="../ajax/authenticated-ajax.html">
<link rel="import" href="../pull-request/pull-request-diff.html">

<dom-module id="project-create-pull-request">
  <template>
    <style>
      :host {
        display: block;
        padding: 1em;
      }
      .selectBranches {
        padding: 1em;
      }
    </style>
    <authenticated-ajax
      id="ajaxBranches"
      refurl="https://api.github.com/repos/[[owner]]/[[name]]/branches"
      handle-as="json"
      per-page="250"
      last-response="{{branches}}"
      ></authenticated-ajax>

    <authenticated-ajax
      id="ajaxCollaborators"
      refurl="https://api.github.com/repos/[[owner]]/[[name]]/contributors"
      handle-as="json"
      per-page="250"
      last-response="{{contributors}}"
      ></authenticated-ajax>

    <authenticated-ajax
      id="ajaxDiff"
      refurl="https://api.github.com/repos/[[owner]]/[[name]]/compare/[[name]]:[[baseBranch]]...[[name]]:[[headBranch]]"
      handle-as="text"
      headers='{"Accept": "application/vnd.github.VERSION.diff"}'
      last-response="{{diff}}"
      ></authenticated-ajax>

    <div class="selectBranches">
      Merge into <branch-tag selectable>{{baseBranch}}</branch-tag> from
      <!-- <branch-tag selectable>{{headBranch}}</branch-tag> -->
    </div>
<!--
    <header>
      <span>Merge into</span>

      <paper-dropdown-menu label="base: [[baseBranch]]" value="{{baseBranch}}" no-label-float>
        <paper-menu class="dropdown-content">
          <template is="dom-repeat" items="[[branches]]">
            <paper-item>[[item.name]]</paper-item>
          </template>
        </paper-menu>
      </paper-dropdown-menu>

      <span>from</span>

      <paper-dropdown-menu label="head: [[headBranch]]" value="{{headBranch}}" no-label-float>
        <paper-menu class="dropdown-content">
          <template is="dom-repeat" items="[[branches]]">
            <paper-item>[[item.name]]</paper-item>
          </template>
        </paper-menu>
      </paper-dropdown-menu>
    </header>
    <div>
      Select multiple reviewers:

      <paper-menu class="reviewers-list" multi selected="{{reviewers}}">
        <template is="dom-repeat" items="[[contributors]]">
          <paper-item>[[item.login]]</paper-item>
        </template>
      </paper-menu>

      <paper-button>Create pull request</paper-button>
    </div>
    <div>
      Title:
      <paper-input value="{{title}}"></paper-input>
      <marked-github-element markdown="[[title]]" owner="[[owner]]" name="[[name]]"></marked-github-element>

      Description:
      <paper-textarea value="{{description}}"></paper-textarea>
      <marked-github-element markdown="[[description]]" owner="[[owner]]" name="[[name]]"></marked-github-element>
    </div>

    <prism-highlighter></prism-highlighter>
    <pull-request-diff data-route="diff" diff="[[diff]]"></pull-request-diff> -->
  </template>
  <script>
    Polymer({
      is: 'project-create-pull-request',
      properties: {
        owner: String,
        name: String,
        baseBranch: {
          type: String,
          value: 'master'
        },
        headBranch: String
      },
      observers: [
        '_fetchBranchesAndCollaborators(owner, name)',
        '_fetchDiff(baseBranch, headBranch)'
      ],
      _fetchBranchesAndCollaborators: function() {
        this.$.ajaxBranches.generateRequest();
        this.$.ajaxCollaborators.generateRequest();
      },
      _fetchDiff: function() {
        this.$.ajaxDiff.generateRequest();
      }
    });
  </script>
</dom-module>
