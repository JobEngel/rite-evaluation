<link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../bower_components/prism-element/prism-highlighter.html">
<link rel="import" href="../bower_components/prism-element/prism-style-import.html">
<link rel="import" href="../util/marked-github-element.html">
<link rel="import" href="../util/branch-selector.html">
<link rel="import" href="../util/markdown-input.html">
<link rel="import" href="../ajax/authenticated-ajax.html">
<link rel="import" href="../pull-request/pull-request-diff.html">
<link rel="import" href="project-create-pull-request-description.html">

<dom-module id="project-create-pull-request">
  <template>
    <style>
      :host {
        display: block;
      }
      .selectBranches {
        background-color: var(--primary-background-color);
        padding: 2em 2em;
        border-bottom: solid 1px var(--secondary-background-color);
      }
    </style>
    <authenticated-ajax
      id="ajaxBranches"
      refurl="https://api.github.com/repos/[[owner]]/[[name]]/branches"
      handle-as="json"
      per-page="250"
      last-response="{{branches}}"
      ></authenticated-ajax>

    <authenticated-ajax
      id="ajaxCollaborators"
      refurl="https://api.github.com/repos/[[owner]]/[[name]]/contributors"
      handle-as="json"
      per-page="250"
      last-response="{{contributors}}"
      ></authenticated-ajax>

    <authenticated-ajax
      id="ajaxDiff"
      refurl="https://api.github.com/repos/[[owner]]/[[name]]/compare/[[name]]:[[baseBranch]]...[[name]]:[[headBranch]]"
      handle-as="text"
      headers='{"Accept": "application/vnd.github.VERSION.diff"}'
      last-response="{{diff}}"
      ></authenticated-ajax>

    <div class="selectBranches">
      Merge into
      <branch-selector tabindex="0" branches="[[branchNames]]" selected="{{baseBranch}}" on-selected="_selectHeadBranch"></branch-selector>from
      <branch-selector id="headBranch" tabindex="0" branches="[[branchNames]]" selected="{{headBranch}}" on-selected="_selectTitleInput"></branch-selector>
    </div>

    <project-create-pull-request-description
      id="description"
      owner="[[owner]]"
      name="[[name]]"
      title="[[title]]"
      description="[[description]]"></project-create-pull-request-description>
    <project-create-pull-diff id="diffView" diff=[[diff]]></project-create-pull-diff>
  </template>
  <script>
    Polymer({
      is: 'project-create-pull-request',
      properties: {
        owner: String,
        name: String,
        title: String,
        description: String,
        baseBranch: {
          type: String,
          value: 'master'
        },
        headBranch: {
          type: String,
          value: '<select branch>'
        },
        branchNames: {
          type: Array,
          computed: '_branchNames(branches)'
        }
      },
      observers: [
        '_fetchBranchesAndCollaborators(owner, name)',
        '_fetchDiff(baseBranch, headBranch)',
        '_showDiff(diff)'
      ],
      _fetchBranchesAndCollaborators: function() {
        this.$.ajaxBranches.generateRequest();
        this.$.ajaxCollaborators.generateRequest();
      },
      _fetchDiff: function(baseBranch, headBranch) {
        if (headBranch && headBranch !== '<select branch>') {
          this.$.ajaxDiff.generateRequest();
        }
      },
      _branchNames: function(branches) {
        return branches.map(function(b) {
          return b.name;
        });
      },
      _selectHeadBranch: function() {
        this.$.headBranch.focus();
      },
      _selectTitleInput: function(a) {
        this.$.description.show();
      },
      _showDiff: function(diff) {
        this.$.diffView.show();
      }
    });
  </script>
</dom-module>
