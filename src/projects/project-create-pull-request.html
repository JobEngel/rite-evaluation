<link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../bower_components/prism-element/prism-highlighter.html">
<link rel="import" href="../bower_components/prism-element/prism-style-import.html">
<link rel="import" href="../util/marked-github-element.html">
<link rel="import" href="../util/branch-selector.html">
<link rel="import" href="../util/markdown-input.html">
<link rel="import" href="../ajax/authenticated-ajax.html">
<link rel="import" href="../pull-request/pull-request-diff.html">

<dom-module id="project-create-pull-request">
  <template>
    <style>
      :host {
        display: block;
      }
      .selectBranches,
      .description {
        padding: 2em 2em;
        border-bottom: solid 1px var(--secondary-background-color);
      }
      .description {
      }

      .selectBranches::before {
        content: "1";
      }
      .description::before {
        content: "2";
      }
      .selectBranches::before,
      .description::before {
        font-weight: 800;
        font-size: 3em;
        color: var(--primary-background-color);
        position: absolute;
        margin-left: -1.5em;
        margin-top: -0.25em;
      }

      .title {
        --paper-input-container: {
          padding: 0 0 1em 0;
        };
        --paper-input-container-input: {
          font-size: 2em;
        };
        --paper-input-container-label: {
          font-size: 2em;
          color: var(--secondary-text-color);
        };
        --paper-input-container-label-floating: {
          font-size: 1em;
        }
        --paper-input-container-color: var(--secondary-background-color);
        --paper-input-container-focus-color: var(--anchor-color);
      }
    </style>
    <authenticated-ajax
      id="ajaxBranches"
      refurl="https://api.github.com/repos/[[owner]]/[[name]]/branches"
      handle-as="json"
      per-page="250"
      last-response="{{branches}}"
      ></authenticated-ajax>

    <authenticated-ajax
      id="ajaxCollaborators"
      refurl="https://api.github.com/repos/[[owner]]/[[name]]/contributors"
      handle-as="json"
      per-page="250"
      last-response="{{contributors}}"
      ></authenticated-ajax>

    <authenticated-ajax
      id="ajaxDiff"
      refurl="https://api.github.com/repos/[[owner]]/[[name]]/compare/[[name]]:[[baseBranch]]...[[name]]:[[headBranch]]"
      handle-as="text"
      headers='{"Accept": "application/vnd.github.VERSION.diff"}'
      last-response="{{diff}}"
      ></authenticated-ajax>

    <div class="selectBranches">
      Merge into
      <branch-selector tabindex="0" branches="[[branchNames]]" selected="{{baseBranch}}" on-selected="_selectHeadBranch"></branch-selector>
      from
      <branch-selector id="headBranch" tabindex="0" branches="[[branchNames]]" selected="{{headBranch}}" on-selected="_selectTitleInput"></branch-selector>
    </div>

    <div class="description">
      <paper-input id="title" class="title" label="Enter a title" value="{{title}}"></paper-input>
      <markdown-input label="Enter a description for your pull request. Markdown is supported." owner="[[owner]]" name="[[name]]"></markdown-input>
    </div>
<!--

    <div>
      Select multiple reviewers:

      <paper-menu class="reviewers-list" multi selected="{{reviewers}}">
        <template is="dom-repeat" items="[[contributors]]">
          <paper-item>[[item.login]]</paper-item>
        </template>
      </paper-menu>

      <paper-button>Create pull request</paper-button>
    </div>\


    <prism-highlighter></prism-highlighter>
    <pull-request-diff data-route="diff" diff="[[diff]]"></pull-request-diff> -->
  </template>
  <script>
    Polymer({
      is: 'project-create-pull-request',
      properties: {
        owner: String,
        name: String,
        baseBranch: {
          type: String,
          value: 'master'
        },
        headBranch: {
          type: String,
          value: '<select branch>'
        },
        branchNames: {
          type: Array,
          computed: '_branchNames(branches)'
        }
      },
      observers: [
        '_fetchBranchesAndCollaborators(owner, name)',
        '_fetchDiff(baseBranch, headBranch)'
      ],
      _fetchBranchesAndCollaborators: function() {
        this.$.ajaxBranches.generateRequest();
        this.$.ajaxCollaborators.generateRequest();
      },
      _fetchDiff: function(baseBranch, headBranch) {
        if (headBranch && headBranch !== '<select branch>') {
          this.$.ajaxDiff.generateRequest();
        }
      },
      _branchNames: function(branches) {
        return branches.map(function(b) {
          return b.name;
        });
      },
      _selectHeadBranch: function() {
        this.$.headBranch.focus();
      },
      _selectTitleInput: function() {
        this.$.title.focus();
      }
    });
  </script>
</dom-module>
