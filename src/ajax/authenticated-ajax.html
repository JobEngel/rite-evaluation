<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">

<dom-module id="authenticated-ajax">
  <template>
    <iron-ajax
      id="ajax"
      auto="[[auto]]"
      url="[[refurl]]"
      params="[[params]]"
      method="[[method]]"
      headers="[[headers]]"
      body="[[body]]"
      sync="[[sync]]"
      handle-as="[[handleAs]]"
      with-credentials="[[withCredentials]]"
      timeout="[[timeout]]"
      verbose="[[verbose]]"
      last-request="{{last-request}}"
      loading="{{iron-loading}}"
      last-error="{{last-error}}"
      activeRequests="{{active-requests}}"
      debounce-duration="[[debounceDuration]]"
      json-prefix="[[jsonPrefix]]"
      bubbles="[[bubbles]]"
      on-request="onRequest"
      on-response="onResponse"
      on-error="onError"></iron-ajax>
  </template>
  <script>
  var shared = {
    instances: [],
    accessToken: undefined,
    responseCache: {},
    headerCache: {}
  };

  (function(){
    Polymer({
      is: 'authenticated-ajax',
      properties: {
        shared: {
          type: Object,
          value: function() {
            return Object.create(shared);
          }
        },
        refurl: String,
        params: {
          type: Object,
          computed: '_generateParams(shared)',
          observer: '_maybeFire'
        },
        method: {
          type: String,
          value: 'GET'
        },
        headers: {
          type: Object,
          value: function() {
            return {};
          }
        },
        contentType: {
          type: String,
          value: null
        },
        body: {
          type: Object,
          value: null
        },
        sync: {
          type: Boolean,
          value: false
        },
        handleAs: {
          type: String,
          value: 'json'
        },
        withCredentials: {
          type: Boolean,
          value: false
        },
        timeout: {
          type: Number,
          value: 0
        },
        auto: {
          type: Boolean,
          value: false,
          observer: '_maybeFire'
        },
        verbose: {
          type: Boolean,
          value: false
        },
        lastRequest: {
          type: Object,
          notify: true,
          computed: '_is(last-request)'
        },
        loading: {
          type: Boolean,
          notify: true,
          computed: '_is(iron-loading)'
        },
        lastResponse: {
          type: Object,
          notify: true,
          readOnly: true
        },
        lastError: {
          type: Object,
          notify: true,
          computed: '_is(last-error)'
        },
        activeRequests: {
          type: Array,
          notify: true,
          computed: '_is(active-requests)',
          value: function() {
            return [];
          }
        },
        debounceDuration: {
          type: Number,
          value: 0,
          notify: true
        },
        jsonPrefix: {
          type: String,
          value: ''
        },
        bubbles: {
          type: Boolean,
          value: false
        }
      },

      observers: [
        '_updateIfNoneMatch(refurl)',
        '_updateContentType(contentType)'
      ],

      attached: function() {
        shared.instances.push(function(shared) {
          this.shared = shared;
        }.bind(this));
      },

      _is: function(obj) {
        return obj;
      },
      storeToken: function(token) {
        this.shared.accessToken = token;
        shared.accessToken = token;
        for (var i = 0, l = shared.instances.length; i < l; i++) {
          shared.instances[i](shared);
        }
      },
      _generateParams: function(shared) {
        var accessToken = shared.accessToken;
        if (!accessToken) {
          return undefined;
        }
        return {
          "access_token": accessToken,
          "per_page": 10
        }
      },
      _setHeader: function(name, value) {
        this.headers = this.headers || {};
        this.headers[name] = value;
      },
      _updateIfNoneMatch: function(refurl) {
        var etag = shared.headerCache[refurl];
        if (etag) {
          this._setHeader('If-None-Match', etag);
        }
      },
      _updateContentType: function(contentType) {
        if (!contentType) {
          return;
        }
        this._setHeader('content-type', contentType);
      },
      _maybeFire: function() {
        if (this.auto && !this.loading) {
          this.generateRequest();
        }
      },
      generateRequest: function() {
        this._updateIfNoneMatch(this.refurl);
        return this.$.ajax.generateRequest();
      },
      onRequest: function(e) {
        this.fire('request', e.detail, {
          bubbles: this.bubbles
        });
      },
      onResponse: function(e) {
        shared.headerCache[this.refurl] = e.detail.xhr.getResponseHeader('ETag');
        shared.responseCache[this.refurl] = e.detail.response;
        this._setLastResponse(shared.responseCache[this.refurl]);
        this.fire('response', e.detail, {
          bubbles: this.bubbles
        });
      },
      onError: function(e) {
        shared.headerCache[this.refurl] = e.detail.request.xhr.getResponseHeader('ETag');
        // Cache responses to save the rate limit of the GitHub api
        if (e.detail.request.status === 304) {
          this._setLastResponse(shared.responseCache[this.refurl]);
          // Modify the original request to remove the error and make it a proper respond
          var request = e.detail.request;
          // Inject our last response
          request._setResponse(this.lastResponse);
          this.fire('response', Object.create(request), {
            bubbles: this.bubbles
          });
        } else {
          this.fire('error', e.detail, {
            bubbles: this.bubbles
          });
        }
      }
    });
  })();
  </script>
</dom-module>
