<link rel="import" href="../bower_components/iron-localstorage/iron-localstorage.html">
<link rel="import" href="../bower_components/polymerfire/firebase-app.html">
<link rel="import" href="../bower_components/polymerfire/firebase-auth.html">

<dom-module id="firebase-authentication">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>
    <firebase-app auth-domain="preview-code.firebaseapp.com"
        name="preview-code"
        database-url="https://preview-code.firebaseio.com/"
        api-key="AIzaSyALQRHW7FvJXnjli-QSGgX8eI6FEhCJ3Bg">
    </firebase-app>
    <firebase-auth id="auth"
        app-name="preview-code"
        user="{{user}}" provider="github"
        signed-in="{{signedIn}}"
        ></firebase-auth>
    <iron-localstorage name="token-storage"
        value="{{_tokens}}"
        on-iron-localstorage-load-empty="_setEmptyTokens"
      ></iron-localstorage>
  </template>
  <script>
    Polymer({
      is: 'firebase-authentication',
      properties: {
        loading: {
          type: Boolean,
          notify: true
        },
        _tokens: Object
      },
      attached: function() {
        this._parseSuccesfulResult = this._parseSuccesfulResult.bind(this);
        if (this.$.auth.auth) {
          this.signIn();
        }
      },
      signIn: function() {
        this.$.auth.auth.getRedirectResult().then(function(result) {
          this.loading = false;
          if (!result.credential) {
            if (this.signedIn && this._tokens.GitHub) {
              this.fire('github-token', this._tokens.GitHub);
              return;
            }
            this.$.auth.signInWithRedirect();
          } else {
            this._parseSuccesfulResult(result);
          }
        }.bind(this)).catch(function(error) {
          // Handle Errors here.
          var errorCode = error.code;
          var errorMessage = error.message;
          // The email of the user's account used.
          var email = error.email;
          // The firebase.auth.AuthCredential type that was used.
          var credential = error.credential;
          // ...
          this.loading = false;
        });
      },
      _parseSuccesfulResult: function(result) {
        var token = result.credential.accessToken;
        this.set('_tokens.GitHub', token);
        this.fire('github-token', token);
      },
      _setEmptyTokens: function() {
        this._tokens = {
          GitHub: ''
        };
      }
    });
  </script>
</dom-module>
