<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../../bower_components/marked-element/marked-element.html">

<link rel="import" href="pull-request-comment.html">
<link rel="import" href="pull-request-add-comments.html">
<link rel="import" href="../util/to-date-string-behavior.html">
<link rel="import" href="../ajax/authenticated-ajax.html">

<dom-module id="pull-request-general-information">
  <template>
    <style>
      :host {
        display: block;
      }
      .pr-text {
        flex:1;
      }
      .pr-time {
        text-align: right;
      }
      .pr-topinfo {
        display:flex;
      }
      .review-true {
        width:17px;
        height:17px;
        color:white;
        background-color: var(--primary-action-green);
        border-radius: 8px;
      }
      .review-false {
        width:17px;
        height:17px;
        background-color: var(--primary-action-red);
        color:white;
        border-radius: 8px;
      }
      .pr-right-side {
        display:block;
      }
      .pr-info{
        width: 52px;
        height: 52px;
      }
      .pr-repeat{
        display:flex;
        overflow-y: auto;
      }
    </style>
    <authenticated-ajax
      id="ajaxComments"
      refurl="[[pr._links.comments.href]]"
      handle-as="json"
      last-response="{{comments}}"></authenticated-ajax>

    <div class="overview">
      <div class="pr-topinfo">
        <div class="pr-text">
          <marked-element markdown="[[pr.body]]" callback="[[callback(owner,name)]]"></marked-element>
        </div>
        <div class="pr-right-side">
          <p>[[toDateString(pr.created_at)]] ago</p>
          <div class="pr-repeat">
            <template is="dom-repeat" items="[[pr.reviewers]]" as="reviewers">
              <div class="pr-info" style$="background-image: url([[reviewers.profile]]); background-repeat: no-repeat; background-size: 50px 50px;">
                <template is="dom-if" if="[[_equals(reviewers.lgtm,'true')]]" restamp="true">
                  <iron-icon class="review-true", icon="icons:check-circle"></iron-icon>
                </template>
                <template is="dom-if" if="[[!_equals(reviewers.lgtm,'true')]]" restamp="true">
                  <iron-icon class="review-false", icon="icons:cancel"></iron-icon>
                </template>
              </div>
            </template>
          </div>
        </div>
      </div>
      <h3>Comments:</h3>
        <template is="dom-repeat" items="[[comments]]">
          <pull-request-comment comment="[[item]]"></pull-request-comment>
        </template>
        <pull-request-add-comments comments="{{comments}}"></pull-request-add-comments>
    </div>
  </template>
  <script>
    Polymer({
      is: 'pull-request-general-information',
      behaviors: [ToDateStringBehavior],
      properties: {
        pr: Object,
        owner: String,
        name: String
      },
      observers: [
        '_fireAjax(pr)'
      ],
      _fireAjax: function() {
        this.$.ajaxComments.generateRequest();
      },
      _equals: function(one, other) {
        return one === other;
      },
      callback: function(owner, name) {
        return function(err, text) {
          return text.replace(/&?#(\d+)/g, function(match, digits) {
            // Character was escaped, we should modify these numbers
            if (match.charAt(0) === '&') {
              return match;
            }
            return '<a href="https://www.github.com/' + owner + '/' + name + '/issues/' + digits + '" target="_blank">#' + digits + '</a>';
          });
        };
      }
    });
  </script>
</dom-module>
