<link rel="import" href="../ajax/authenticated-ajax.html">
<link rel="import" href="../util/hide-content.html">
<link rel="import" href="../util/marked-github-element.html">

<dom-module id="pull-request-commits">
  <template>
    <style>
      :host {
        display: flex;
        flex-direction: column;
      }
      [hidden] {
        display: none !important;
      }
      .icon {
        display: flex;
        width: 64px;
        height: 64px;
        margin-right: 5px;
      }
      .message {
        font-weight: bold;
        --commits: {
          display: inline;
        };
      }
      .top-container {
        display: flex;
        flex-direction: row;
        margin-bottom: 2px;
        padding: 1em;
      }
      .commit-text {
        --hide-content: {
          display: inline;
        };
      }
      .commited {
        margin-left: 1em;
        margin-top: 1em;
        margin-bottom: -1em;
      }
      .commits {
        box-shadow: 0 0 8px 0 rgba(0,0,0,0.2);
        background-color: white;
      }
      a {
        color: var(--primary-text-color);
        text-decoration: none;
      }
      a:hover {
        text-decoration: underline;
      }
    </style>
    <authenticated-ajax
      id="ajaxComments"
      refurl="[[pullRequest._links.commits.href]]"
      handle-as="json"
      per-page="50"
      last-response="{{commits}}"></authenticated-ajax>

    <div class="commits">
      <template is="dom-repeat" items="{{commits}}" index-as="index">
        <div class="commit">
          <div class="commited">
            <span>[[item.author.login]] commited [[toDateString(item.commit.committer.date)]] ago:</span>
          </div>
          <div class="top-container">
            <div class="right-column">
              <img class="icon" src="[[item.author.avatar_url]]" alt="[[item.author.login]] avatar"/>
            </div>
            <div class="container">
              <a href$="[[item.html_url]]" target="_blank">
                [[_getFirst(project, item.commit.message)]]
              </a>
              <hide-content class="commit-text" hidden$="[[_empty(item.commit.message)]]">
                <marked-github-element class="description" markdown="[[_getLast(item.commit.message)]]" project="[[project]]"></marked-github-element>
              </hide-content>
            </div>
          </div>
        </div>
      </template>
    </div>
  </template>
  <script>
    Polymer({
      is: 'pull-request-commits',
      behaviors: [ToDateStringBehavior, SubstituteRenderedGitHubMarkdownBehavior],
      properties: {
        pullRequest: Object,
        commits: Array,
        project: Object
      },
      observers: [
        '_fireAjax(pullRequest)',
      ],
      _fireAjax: function() {
        this.$.ajaxComments.generateRequest();
      },
      _getFirst: function(project, text) {
        return this.createMarkdownSubstituter(project.owner, project.name)(null, text.split('\n\n')[0]);
      },
      _getLast: function(text) {
        return text.substring(text.indexOf('\n\n')+1);
      },
      _empty: function(text) {
        return text.split('\n\n')[1] === undefined;
      }
    });
  </script>
</dom-module>
