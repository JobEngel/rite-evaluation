<link rel="import" href="../bower_components/Sortable/Sortable.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="pull-request-diff-highlight.html">
<link rel="import" href="pull-request-add-comments.html">
<link rel="import" href="pull-request-comment.html">
<link rel="import" href="../util/markdown-input.html">
<link rel="import" href="../util/collapse-icon.html">

<dom-module id="pull-request-chunk">
  <template>
    <style>
      [hidden] {
        display: none !important;
      }
      :host {
        overflow: hidden;
        display: block;
        margin: 2em 0;
        padding: 1em 2em;
        background-color: var(--primary-background-color);
        -webkit-transition: all 0.3s ease;
        -moz-transition: all 0.3s ease;
        -ms-transition: all 0.3s ease;
        -o-transition: all 0.3s ease;
        transition: all 0.3s ease;
        -webkit-box-shadow: 0 0 8px 0 rgba(0,0,0,0.2);
        box-shadow: 0 0 8px 0 rgba(0,0,0,0.2);
      }
      :host([collapsed]) {
        height: 3em;
      }
      header {
        min-height: 2em;
      }
      h2.title {
        height: 25px;
      }
      .diffs {
        width: 100%;
        display: block;
        min-height: 2em;
      }
      h2 {
        margin-bottom: 1em;
        margin-top: 0.5em;
      }
      paper-input.title {
        --paper-input-container: {
          padding: 0 0 1em 0;
        };
        --paper-input-container-input: {
          font-size: 1.5em;
        };
        --paper-input-container-label: {
          font-size: 1.5em;
          color: var(--secondary-text-color);
        };
        --paper-input-container-label-floating: {
          font-size: 1em;
        }
        --paper-input-container-color: var(--secondary-background-color);
        --paper-input-container-focus-color: var(--anchor-color);
      }
      .toggle-comments {
        background-color: var(--secondary-background-color);
        padding: 0.5em;
      }
    </style>
    <header>
      <collapse-icon collapsed="{{collapsed}}"></collapse-icon>
      <paper-input hidden$="[[!editable]]" class="title" label="Enter a title for this chunk" value="{{title}}"></paper-input>
      <h2 hidden$="[[_is(editable, title)]]">[[title]]</h2>
      <markdown-input
        hidden$="[[_is(editable, description)]]"
        disabled="[[!editable]]"
        label="Enter a description for these changes. Markdown is supported."
        markdown="{{description}}"
        project="[[project]]"></markdown-input>
    </header>
    <sortable-js class="diffs" group="chunk" draggable="pull-request-diff-highlight"
        disabled="[[!editable]]" on-remove="_diffRemoved"
        on-update="_diffMoved"
        on-add="_diffAdded">
      <template is="dom-repeat" id="repeat" items="[[chunk.diff]]" on-dom-change="_addChunkToSortableGroup">
        <pull-request-diff-highlight code="[[item.changes]]" lines-changed="[[item.linesChanged]]" file="[[item.file]]" file-url="[[item.fileUrl]]"></pull-request-diff-highlight>
      </template>
    </sortable-js>

    <p class="toggle-comments" hidden$="[[editable]]">
      <span>comments</span>
      <collapse-icon collapsed="{{showComments}}"></collapse-icon>
    </p>
    <div class="chunk-comment" hidden$="[[showComments]]">
      <template is="dom-repeat" items="[[chunk.comments]]" as="comment">
        <pull-request-comment
            text="[[comment.body]]" author="[[comment.user]]"
            date="[[comment.timeopened]]" project="[[project]]"></pull-request-comment>
      </template>
      <pull-request-add-comments comments="{{chunk.comments}}"></pull-request-add-comments>
    </div>
  </template>
  <script>
    Polymer({
      is: 'pull-request-chunk',
      properties: {
        editable: {
          type: Boolean,
          value: false
        },
        chunk: Object,
        title: String,
        description: {
          type: String,
          value: ''
        },
        showComments: {
          type: Boolean,
          value: true
        },
        collapsed: {
          type: Boolean,
          reflectToAttribute: true
        },
        project: Object
      },
      _addChunkToSortableGroup: function() {
        if (this.editable) {
          var diffs = this.$$('sortable-js').getElementsByClassName('diff');
          for (var i = 0, l = diffs.length; i < l; i++) {
            if (!diffs[i].__added) {
              Sortable.create(diffs[i], {
                group: 'chunk'
              });
              diffs[i].__added = true;
            }
          }
        }
      },
      observers: [
        '_toggleEditable(editable)'
      ],
      _diffAdded: function(e) {
        if (e.detail) {
          var invertedIndex = (e.detail.newIndex) ? 0 : 1;
          // Remove the dummy diff
          if (!this.chunk.diff[invertedIndex].changes) {
            var changes = this.chunk.diff.slice()[e.detail.newIndex];
            this.set('chunk', {
              diff: [{
                file: changes.file,
                diffId: changes.diffId,
                fileUrl: changes.file,
                changes: changes.changes
              }]
            });
            this.fire('upgraded', {
              file: changes.file,
              diffId: changes.diffId
            });
          }
        }
      },
      _diffMoved: function(e) {
        if (e.detail) {
          console.log('Moved from %d to %d', e.detail.newIndex, e.detail.oldIndex);
        }
      },
      _diffRemoved: function(e) {
        if (!this.chunk.diff.length) {
          this.fire('empty');
        }
      },
      _toggleEditable: function(editable) {
        this.showComments = this.showComments && !editable
      },
      _is: function(editable, description) {
        return !editable && description;
      }
    });
  </script>
</dom-module>
