<link rel="import" href="../bower_components/Sortable/Sortable.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">

<link rel="import" href="pull-request-diff-highlight.html">
<link rel="import" href="pull-request-add-comments.html">
<link rel="import" href="pull-request-comment.html">
<link rel="import" href="../util/marked-github-element.html">

<dom-module id="pull-request-chunk">
  <template>
    <style>
      :host {
        overflow: hidden;
        display: block;
        margin: 2em 0;
        padding: 1em 2em;
        border-radius: 1em;
        background-color: var(--primary-background-color);
        -webkit-transition: all 0.3s ease;
        -moz-transition: all 0.3s ease;
        -ms-transition: all 0.3s ease;
        -o-transition: all 0.3s ease;
        transition: all 0.3s ease;
      }
      :host([collapsed]) {
        height: 3em;
      }
      .title {
        height: 25px;
      }
      sortable-js {
        width: 100%;
        display: block;
        min-height: 2em;
      }
      h2 {
        margin-bottom: 1em;
        margin-top: 0.5em;
      }
      header iron-icon {
        fill: var(--pr-status-color);
        float: right;
        opacity: 0;
        -webkit-transition: all 0.3s ease;
        -moz-transition: all 0.3s ease;
        -ms-transition: all 0.3s ease;
        -o-transition: all 0.3s ease;
        transition: all 0.3s ease;
        border-radius: 12px;
      }
      header iron-icon:hover {
        fill: var(--primary-action-red);
      }
      :host(:hover) header iron-icon {
        opacity: 1;
      }
    </style>
    <header>
      <iron-icon icon="icons:remove-circle-outline" on-tap="_toggleCollapse"></iron-icon>
      <h2>[[title]]</h2>
      <marked-github-element markdown="[[description]]" owner="[[owner]]" name="[[name]]"></marked-github-element>
    </header>
    <sortable-js group="chunk" draggable="pull-request-diff-highlight" on-remove="_diffRemoved">
      <template is="dom-repeat" items="[[chunk.diff]]">
        <pull-request-diff-highlight code="[[item.changes]]" file="[[item.file]]"></pull-request-diff-highlight>
      </template>
    </sortable-js>
    <iron-icon icon="icons:arrow-downward" class="toggle-comments-icon" on-tap="_toggleComments"></iron-icon>
    <div class="chunk-comment" hidden$="[[showComments]]">
      <template is="dom-repeat" items="[[chunk.comments]]" as="comment">
        <pull-request-comment comment="[[comment]]"></pull-request-comment>
      </template>
      <pull-request-add-comments comments="{{chunk.comments}}"></pull-request-add-comments>
    </div>
  </template>
  <script>
    Polymer({
      is: 'pull-request-chunk',
      properties: {
        chunk: Object,
        title: {
          type: String,
          value: 'Untitled chunk'
        },
        description: {
          type: String,
          value: 'Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed turpis lectus, consequat nec feugiat ac, accumsan non dui. Fusce varius pretium sem ut vulputate. Ut sagittis tortor et elit faucibus cursus. Suspendisse imperdiet eros ac purus placerat ullamcorper. Nunc blandit interdum ante, sit amet malesuada enim vestibulum in. Morbi efficitur eget augue eget convallis. Vestibulum tempus, lorem non rhoncus ultricies, libero nisi tincidunt neque, in eleifend mi arcu vel felis. Vivamus ut rutrum nisl, at varius augue. Ut ligula massa, semper sit amet elit eu, molestie auctor risus. Vestibulum ante ipsum primis in faucibus orci luctus et ultrices posuere cubilia Curae; Mauris justo justo, varius vel pretium et, placerat id diam.'
        },
        showComments: {
          type: Boolean,
          value: true
        },
        collapsed: {
          type: Boolean,
          reflectToAttribute: true
        }
      },
      attached: function() {
        var diffs = this.$$('sortable-js').getElementsByClassName('diff');
        for (var i = 0, l = diffs.length; i < l; i++) {
          Sortable.create(diffs[i], {
            group: 'chunk'
          });
        }
      },
      _diffRemoved: function() {
        if (!this.chunk.diff.length) {
          this.fire('empty');
        }
      },
      _toggleComments: function() {
        this.showComments = !this.showComments;
      },
      _toggleCollapse: function() {
        this.collapsed = !this.collapsed;
      }
    });
  </script>
</dom-module>
