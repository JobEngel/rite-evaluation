<link rel="import" href="../bower_components/Sortable/Sortable.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="pull-request-diff-highlight.html">
<link rel="import" href="pull-request-add-comments.html">
<link rel="import" href="pull-request-comment.html">
<link rel="import" href="../util/markdown-input.html">
<link rel="import" href="../util/collapse-icon.html">

<dom-module id="pull-request-chunk">
  <template>
    <style>
      [hidden] {
        display: none !important;
      }
      :host {
        overflow: hidden;
        display: block;
        margin: 2em 0;
        padding: 1em 2em;
        background-color: var(--primary-background-color);
        -webkit-transition: all 0.3s ease;
        -moz-transition: all 0.3s ease;
        -ms-transition: all 0.3s ease;
        -o-transition: all 0.3s ease;
        transition: all 0.3s ease;
        -webkit-box-shadow: 0 0 8px 0 rgba(0,0,0,0.2);
        box-shadow: 0 0 8px 0 rgba(0,0,0,0.2);
      }
      :host([collapsed]) {
        height: 3em;
      }
      header {
        min-height: 2em;
      }
      h2.title {
        height: 25px;
      }
      .diffs {
        width: 100%;
        display: block;
        min-height: 2em;
      }
      h2 {
        margin-bottom: 1em;
        margin-top: 0.5em;
      }
      paper-input.title {
        --paper-input-container: {
          padding: 0 0 1em 0;
        };
        --paper-input-container-input: {
          font-size: 1.5em;
        };
        --paper-input-container-label: {
          font-size: 1.5em;
          color: var(--secondary-text-color);
        };
        --paper-input-container-label-floating: {
          font-size: 1em;
        }
        --paper-input-container-color: var(--secondary-background-color);
        --paper-input-container-focus-color: var(--anchor-color);
      }
    </style>
    <header>
      <collapse-icon collapsed="{{collapsed}}"></collapse-icon>
      <paper-input hidden$="[[!editable]]" class="title" label="Enter a title for this chunk" value="{{title}}"></paper-input>
      <h2 hidden$="[[_is(editable, title)]]">[[title]]</h2>
      <markdown-input
        hidden$="[[_is(editable, description)]]"
        disabled="[[!editable]]"
        label="Enter a description for these changes. Markdown is supported."
        markdown="{{description}}"
        project="[[project]]"></markdown-input>
    </header>
    <sortable-js class="diffs" group="chunk" draggable="pull-request-diff-highlight" disabled="[[!editable]]" on-remove="_diffRemoved">
      <template is="dom-repeat" items="[[chunk.diff]]">
        <pull-request-diff-highlight code="[[item.changes]]" file="[[item.file]]" file-url="[[item.fileUrl]]"></pull-request-diff-highlight>
      </template>
    </sortable-js>

    <iron-icon
      icon="icons:arrow-downward"
      class="toggle-comments-icon"
      on-tap="_toggleComments"
      hidden$="[[editable]]"
    ></iron-icon>
    <div class="chunk-comment" hidden$="[[showComments]]">
      <template is="dom-repeat" items="[[chunk.comments]]" as="comment">
        <pull-request-comment
            text="[[comment.body]]" author="[[comment.user]]"
            date="[[comment.timeopened]]" project="[[project]]"></pull-request-comment>
      </template>
      <pull-request-add-comments comments="{{chunk.comments}}"></pull-request-add-comments>
    </div>
  </template>
  <script>
    Polymer({
      is: 'pull-request-chunk',
      properties: {
        editable: {
          type: Boolean,
          value: false
        },
        chunk: Object,
        title: String,
        description: {
          type: String,
          value: ''
        },
        showComments: {
          type: Boolean,
          value: true
        },
        collapsed: {
          type: Boolean,
          reflectToAttribute: true
        },
        project: Object
      },
      attached: function() {
        if (this.editable) {
          var diffs = this.$$('sortable-js').getElementsByClassName('diff');
          for (var i = 0, l = diffs.length; i < l; i++) {
            Sortable.create(diffs[i], {
              group: 'chunk'
            });
          }
        }
      },
      observers: [
        '_toggleEditable(editable)'
      ],
      _diffRemoved: function() {
        if (!this.chunk.diff.length) {
          this.fire('empty');
        }
      },
      _toggleComments: function() {
        this.showComments = !this.showComments;
      },
      _toggleEditable: function(editable) {
        this.showComments = this.showComments && !editable
      },
      _is: function(editable, description) {
        return !editable && description;
      }
    });
  </script>
</dom-module>
