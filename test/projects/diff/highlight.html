<!doctype html>
<html>
<head>
  <meta name='viewport' content='width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes'>
  <title>diff-highlight-tests</title>
  <script src='../../../src/bower_components/webcomponentsjs/webcomponents-lite.min.js'></script>
  <script src='../../../src/bower_components/web-component-tester/browser.js'></script>
  <script src='test-diffs.js'></script>

  <!-- Import the element to test -->
  <link rel='import' href='../../../src/projects/diff/highlight.html'>

</head>
<body>

  <test-fixture id="basic">
    <template>
      <pull-request-diff-highlight></pull-request-diff-highlight>
    </template>
  </test-fixture>

  <script>
  /*global testDiffs*/
    suite('<pull-request-diff-highlight>', function() {
      var diffElem;
      setup(function() {
        replace('collapse-icon').with('stub-collapse-icon');
        diffElem = fixture('basic');
      });

      test('renders when attached', function(done) {
        var elem = document.createElement('pull-request-diff-highlight');
        elem._render = function() {
          done();
        }
        document.body.appendChild(elem);
      });

      test('renders when code changes', function(done) {
        diffElem._render = function() {
          done();
        }
        diffElem.code = "+ insert!";
      });
    });


    testDiffs.forEach(function(diff) {
      suite("diff: " + diff.index, function() {
        var diffElem;

        setup(function() {
          replace('collapse-icon').with('stub-collapse-icon');
          diffElem = fixture('basic');
          diffElem.code = diff.changes;
          diffElem.linesChanged = diff.linesChanged;
        });

        test('shows correct amount of `before` lines', function() {
          var beforeLines = filterEmpty(getChildrenForId('beforeColumn'), '');
          assert.equal(diff.linesChanged.rangeBefore, beforeLines.length);
        });

        test('shows correct amount of `after` lines', function() {
          var afterLines = filterEmpty(getChildrenForId('afterColumn'), '');
          assert.equal(diff.linesChanged.rangeAfter, afterLines.length);
        });

        test('shows correct amount of empty `before` lines', function() {
          var beforeLines = filterNonEmpty(getChildrenForId('beforeColumn'));
          var diffLines = diff.changes.split('\n')
          var emptyBeforeLines = diffLines.filter(function(line) {
            return line.startsWith('+');
          });
          assert.equal(emptyBeforeLines.length, beforeLines.length);
        });

        test('shows correct amount of empty `after` lines', function() {
          var afterLines = filterNonEmpty(getChildrenForId('afterColumn'));
          var diffLines = diff.changes.split('\n')
          var emptyAfterLines = diffLines.filter(function(line) {
            return line.startsWith('-');
          });
          assert.equal(emptyAfterLines.length, afterLines.length);
        });

        var getChildrenForId = function(id) {
          return [].slice.call(Polymer.dom(diffElem.root).querySelector('#' + id).children)
        }

        var filterEmpty = function(elems) {
          return elems.filter(function(e) {
            return e.innerHTML !== '';
          });
        }

        var filterNonEmpty = function(elems) {
          return elems.filter(function(e) {
            return e.innerHTML === '';
          });
        }
      });
    });
  </script>
</body>
</html>
